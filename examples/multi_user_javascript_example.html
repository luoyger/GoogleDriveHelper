<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šç”¨æˆ· Google Drive API ç¤ºä¾‹</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        .section h3 {
            margin-top: 0;
            color: #4285f4;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input[type="text"], input[type="file"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        button {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #3367d6;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .success {
            color: #4caf50;
            background-color: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            color: #f44336;
            background-color: #fde8e8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .info {
            color: #2196f3;
            background-color: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .file-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .user-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .code-block {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” å¤šç”¨æˆ· Google Drive API ç¤ºä¾‹</h1>
            <p>æ¯ä¸ªç”¨æˆ·ä½¿ç”¨è‡ªå·±çš„ Google Drive è´¦æˆ·</p>
        </div>

        <!-- é…ç½®éƒ¨åˆ† -->
        <div class="section">
            <h3>âš™ï¸ åº”ç”¨é…ç½® (ä»…ç®¡ç†å‘˜è®¾ç½®)</h3>
            <div class="info">
                <strong>âš ï¸ é‡è¦è¯´æ˜ï¼š</strong>è¿™äº›æ˜¯åº”ç”¨å¼€å‘è€…çš„å‡­æ®ï¼Œä¸æ˜¯ç”¨æˆ·çš„ï¼<br>
                â€¢ ç”¨æˆ·æ— éœ€åˆ° Google Console è·å–ä»»ä½•å‡­æ®<br>
                â€¢ ç”¨æˆ·åªéœ€é€šè¿‡ Google è´¦æˆ·ç™»å½•æˆæƒå³å¯<br>
                â€¢ ä»¥ä¸‹é…ç½®ç”±åº”ç”¨ç®¡ç†å‘˜ä¸€æ¬¡æ€§è®¾ç½®
            </div>
            <div class="form-group">
                <label for="apiBaseUrl">API åŸºç¡€ URL:</label>
                <input type="text" id="apiBaseUrl" value="http://localhost:8080" />
            </div>
            <div class="form-group">
                <label for="clientId">åº”ç”¨çš„ OAuth å®¢æˆ·ç«¯ ID (å¼€å‘è€…å‡­æ®):</label>
                <input type="text" id="clientId" placeholder="your-app-client-id.apps.googleusercontent.com" />
                <small style="color: #666;">ç”±åº”ç”¨å¼€å‘è€…åœ¨ Google Cloud Console ä¸­åˆ›å»º</small>
            </div>
            <div class="form-group">
                <label for="clientSecret">åº”ç”¨çš„ OAuth å®¢æˆ·ç«¯å¯†é’¥ (å¼€å‘è€…å‡­æ®):</label>
                <input type="text" id="clientSecret" placeholder="GOCSPX-your-app-client-secret" />
                <small style="color: #666;">ä¸å®¢æˆ·ç«¯ ID é…å¥—ï¼Œä¿å¯†å­˜å‚¨</small>
            </div>
            <div class="form-group">
                <label for="redirectUri">é‡å®šå‘ URI:</label>
                <input type="text" id="redirectUri" value="http://localhost:8080/callback" />
                <small style="color: #666;">åœ¨ Google Console ä¸­é…ç½®çš„å›è°ƒåœ°å€</small>
            </div>
        </div>

        <!-- ç”¨æˆ·æˆæƒéƒ¨åˆ† -->
        <div class="section">
            <h3>ğŸ” ç”¨æˆ·æˆæƒ</h3>
            <div class="info">
                <strong>âš ï¸ é‡è¦è¯´æ˜ï¼š</strong><br>
                â€¢ <strong>"ç”¨æˆ· ID"</strong> åªæ˜¯åº”ç”¨å†…éƒ¨çš„æ ‡è¯†ç¬¦ï¼Œå¯ä»¥æ˜¯ä»»æ„åå­—ï¼ˆå¦‚ï¼šalice, bob, å¼ ä¸‰ï¼‰<br>
                â€¢ <strong>å®é™…ç™»å½•çš„ Google è´¦æˆ·</strong> ç”±ç”¨æˆ·åœ¨ Google æˆæƒé¡µé¢å†³å®š<br>
                â€¢ ä¸ç®¡å¡«ä»€ä¹ˆç”¨æˆ· IDï¼Œéƒ½ä¼šè·³è½¬åˆ° Google è®©<strong>å½“å‰æµè§ˆå™¨ç”¨æˆ·</strong>ç™»å½•<br>
                â€¢ å¦‚æœè¦æµ‹è¯•ä¸åŒç”¨æˆ·ï¼Œéœ€è¦åœ¨ä¸åŒæµè§ˆå™¨æˆ–éšèº«æ¨¡å¼ä¸­æ“ä½œ
            </div>
            <div class="form-group">
                <label for="userId">ç”¨æˆ· ID (åº”ç”¨å†…æ ‡è¯†):</label>
                <input type="text" id="userId" placeholder="ä¾‹å¦‚: alice, bob, charlie, å¼ ä¸‰, æå››" />
                <small style="color: #666;">è¿™åªæ˜¯ä¸ºäº†åŒºåˆ†ä¸åŒç”¨æˆ·çš„ä»¤ç‰Œï¼Œä¸ Google è´¦æˆ·æ— å…³</small>
            </div>
            <button onclick="getAuthUrl()">è·å–æˆæƒ URL</button>
            <div id="authResult"></div>
            
            <div class="form-group" style="margin-top: 20px;">
                <label for="authCode">æˆæƒç ï¼ˆç”¨æˆ·æˆæƒåè·å¾—ï¼‰:</label>
                <input type="text" id="authCode" placeholder="ä» Google é‡å®šå‘ URL ä¸­è·å–çš„ code å‚æ•°" />
            </div>
            <button onclick="exchangeCodeForToken()">æ¢å–è®¿é—®ä»¤ç‰Œ</button>
            <div id="tokenResult"></div>
        </div>

        <!-- ç”¨æˆ·ä»¤ç‰Œç®¡ç† -->
        <div class="section">
            <h3>ğŸ« ç”¨æˆ·ä»¤ç‰Œç®¡ç†</h3>
            <div class="form-group">
                <label for="userToken">å½“å‰ç”¨æˆ·ä»¤ç‰Œ (JSON æ ¼å¼):</label>
                <textarea id="userToken" placeholder='{"access_token":"...","refresh_token":"...","client_id":"...","client_secret":"..."}'></textarea>
            </div>
            <button onclick="validateToken()">éªŒè¯ä»¤ç‰Œ</button>
            <button onclick="getUserInfo()">è·å–ç”¨æˆ·ä¿¡æ¯</button>
            <div id="userInfoResult"></div>
        </div>

        <!-- æ–‡ä»¶æ“ä½œéƒ¨åˆ† -->
        <div class="section">
            <h3>ğŸ“ æ–‡ä»¶æ“ä½œ</h3>
            
            <!-- ä¸Šä¼ æ–‡ä»¶ -->
            <div class="form-group">
                <label for="fileUpload">é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶:</label>
                <input type="file" id="fileUpload" />
            </div>
            <div class="form-group">
                <label for="parentFolderId">çˆ¶æ–‡ä»¶å¤¹ ID (å¯é€‰):</label>
                <input type="text" id="parentFolderId" placeholder="ç•™ç©ºè¡¨ç¤ºä¸Šä¼ åˆ°æ ¹ç›®å½•" />
            </div>
            <button onclick="uploadFile()">ä¸Šä¼ æ–‡ä»¶</button>
            <div id="uploadResult"></div>

            <!-- æ–‡ä»¶åˆ—è¡¨ -->
            <div style="margin-top: 20px;">
                <div class="form-group">
                    <label for="searchQuery">æœç´¢æ¡ä»¶ (å¯é€‰):</label>
                    <input type="text" id="searchQuery" placeholder="ä¾‹å¦‚: name contains 'test'" />
                </div>
                <button onclick="listFiles()">è·å–æ–‡ä»¶åˆ—è¡¨</button>
                <button onclick="listFiles('image/')" style="background-color: #ff9800;">ä»…å›¾ç‰‡</button>
                <button onclick="listFiles('application/pdf')" style="background-color: #9c27b0;">ä»…PDF</button>
                <div id="fileListResult"></div>
            </div>

            <!-- æ–‡ä»¶ä¸‹è½½ -->
            <div style="margin-top: 20px;">
                <div class="form-group">
                    <label for="downloadFileId">è¦ä¸‹è½½çš„æ–‡ä»¶ ID:</label>
                    <input type="text" id="downloadFileId" placeholder="ä»æ–‡ä»¶åˆ—è¡¨ä¸­å¤åˆ¶æ–‡ä»¶ ID" />
                </div>
                <button onclick="downloadFile()">ä¸‹è½½æ–‡ä»¶</button>
                <div id="downloadResult"></div>
            </div>
        </div>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="section">
            <h3>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h3>
            <div class="info">
                <h4>ğŸ”‘ OAuth 2.0 è®¤è¯è§’è‰²è¯´æ˜ï¼š</h4>
                <div style="background-color: #fff3cd; padding: 15px; border-radius: 4px; margin: 10px 0;">
                    <strong>å¼€å‘è€…ï¼ˆåº”ç”¨ç®¡ç†å‘˜ï¼‰ï¼š</strong><br>
                    â€¢ åœ¨ Google Cloud Console åˆ›å»ºåº”ç”¨å’Œ OAuth å‡­æ®<br>
                    â€¢ è®¾ç½® CLIENT_ID å’Œ CLIENT_SECRETï¼ˆä¸€æ¬¡æ€§é…ç½®ï¼‰<br>
                    â€¢ é…ç½®é‡å®šå‘ URI å’Œæƒé™èŒƒå›´<br><br>
                    
                    <strong>æ™®é€šç”¨æˆ·ï¼š</strong><br>
                    â€¢ æ— éœ€ä»»ä½•æŠ€æœ¯é…ç½®<br>
                    â€¢ åªéœ€è¦æœ‰ Google è´¦æˆ·<br>
                    â€¢ ç‚¹å‡»æˆæƒé“¾æ¥ï¼Œç”¨è‡ªå·±çš„ Google è´¦æˆ·ç™»å½•<br>
                    â€¢ æˆæƒåº”ç”¨è®¿é—®è‡ªå·±çš„ Google Drive<br>
                    â€¢ å¼€å§‹ä½¿ç”¨è‡ªå·±çš„ Google Drive å­˜å‚¨ç©ºé—´
                </div>
                
                <h4>å¤šç”¨æˆ·æ¨¡å¼å·¥ä½œæµç¨‹ï¼š</h4>
                <ol>
                    <li><strong>å¼€å‘è€…é…ç½®</strong>ï¼šåº”ç”¨ç®¡ç†å‘˜åœ¨ Google Console åˆ›å»º OAuth åº”ç”¨ï¼Œè·å¾— CLIENT_ID å’Œ CLIENT_SECRET</li>
                    <li><strong>åº”ç”¨éƒ¨ç½²</strong>ï¼šå°†å‡­æ®é…ç½®åˆ°åº”ç”¨ä¸­ï¼ˆé€šå¸¸å­˜å‚¨åœ¨æœåŠ¡å™¨ç¯å¢ƒå˜é‡ä¸­ï¼‰</li>
                    <li><strong>ç”¨æˆ·æ³¨å†Œ</strong>ï¼šç”¨æˆ·è®¿é—®åº”ç”¨ï¼Œç‚¹å‡»"ä½¿ç”¨ Google ç™»å½•"</li>
                    <li><strong>Google æˆæƒ</strong>ï¼šç”¨æˆ·åœ¨ Google é¡µé¢ç™»å½•å¹¶æˆæƒåº”ç”¨è®¿é—®å…¶ Drive</li>
                    <li><strong>è·å–ä»¤ç‰Œ</strong>ï¼šåº”ç”¨è‡ªåŠ¨è·å–ç”¨æˆ·çš„è®¿é—®ä»¤ç‰Œ</li>
                    <li><strong>æ–‡ä»¶æ“ä½œ</strong>ï¼šç”¨æˆ·å¯ä»¥ä¸Šä¼ ã€ä¸‹è½½ã€ç®¡ç†è‡ªå·± Google Drive ä¸­çš„æ–‡ä»¶</li>
                </ol>
                
                <h4>ğŸ§ª å¦‚ä½•æµ‹è¯•å¤šç”¨æˆ·åŠŸèƒ½ï¼š</h4>
                <div style="background-color: #fff3cd; padding: 15px; border-radius: 4px; margin: 10px 0;">
                    <strong>æ–¹æ³• 1ï¼šä½¿ç”¨ä¸åŒæµè§ˆå™¨</strong><br>
                    â€¢ Chrome ä¸­ç”¨ Google è´¦æˆ· A æˆæƒ<br>
                    â€¢ Firefox ä¸­ç”¨ Google è´¦æˆ· B æˆæƒ<br>
                    â€¢ Safari ä¸­ç”¨ Google è´¦æˆ· C æˆæƒ<br><br>
                    
                    <strong>æ–¹æ³• 2ï¼šä½¿ç”¨éšèº«æ¨¡å¼</strong><br>
                    â€¢ æ™®é€šæ¨¡å¼ï¼šç”¨æˆ· A æˆæƒ<br>
                    â€¢ éšèº«æ¨¡å¼ï¼šç”¨æˆ· B æˆæƒ<br>
                    â€¢ æ–°çš„éšèº«çª—å£ï¼šç”¨æˆ· C æˆæƒ<br><br>
                    
                    <strong>æ–¹æ³• 3ï¼šåˆ‡æ¢ Google è´¦æˆ·</strong><br>
                    â€¢ åœ¨ Google æˆæƒé¡µé¢ç‚¹å‡»"ä½¿ç”¨å…¶ä»–è´¦æˆ·"<br>
                    â€¢ ç™»å½•ä¸åŒçš„ Google è´¦æˆ·<br>
                    â€¢ å®Œæˆæˆæƒæµç¨‹<br><br>
                    
                    <strong>âš ï¸ æ³¨æ„ï¼š</strong>æµè§ˆå™¨ä¼šè®°ä½å½“å‰ç™»å½•çš„ Google è´¦æˆ·ï¼Œæ‰€ä»¥ï¼š<br>
                    â€¢ ç”¨æˆ· ID "alice" â†’ å¯èƒ½æˆæƒç»™ yourname@gmail.com<br>
                    â€¢ ç”¨æˆ· ID "bob" â†’ è¿˜æ˜¯ä¼šæˆæƒç»™ yourname@gmail.comï¼ˆå¦‚æœæµè§ˆå™¨å·²ç™»å½•ï¼‰<br>
                    â€¢ è¦çœŸæ­£æµ‹è¯•ä¸åŒç”¨æˆ·ï¼Œéœ€è¦ä½¿ç”¨ä¸åŒçš„ Google è´¦æˆ·ç™»å½•
                </div>
            </div>
            
            <div class="code-block">
                <strong>API ç«¯ç‚¹è¯´æ˜ï¼š</strong><br>
                GET  /api/v1/multi-user/auth - è·å–æˆæƒ URL<br>
                POST /api/v1/multi-user/auth/callback - å¤„ç†æˆæƒå›è°ƒ<br>
                POST /api/v1/multi-user/upload - ä¸Šä¼ æ–‡ä»¶åˆ°ç”¨æˆ· Drive<br>
                GET  /api/v1/multi-user/list - åˆ—å‡ºç”¨æˆ·æ–‡ä»¶<br>
                GET  /api/v1/multi-user/download/{file_id} - ä¸‹è½½ç”¨æˆ·æ–‡ä»¶<br>
                GET  /api/v1/multi-user/user-info - è·å–ç”¨æˆ·ä¿¡æ¯
            </div>
        </div>
    </div>

    <script>
        // å¤šç”¨æˆ· Google Drive API å®¢æˆ·ç«¯ç±»
        class MultiUserGoogleDriveClient {
            constructor() {
                this.baseUrl = document.getElementById('apiBaseUrl').value;
                this.clientId = document.getElementById('clientId').value;
                this.clientSecret = document.getElementById('clientSecret').value;
                this.redirectUri = document.getElementById('redirectUri').value;
            }

            updateConfig() {
                this.baseUrl = document.getElementById('apiBaseUrl').value;
                this.clientId = document.getElementById('clientId').value;
                this.clientSecret = document.getElementById('clientSecret').value;
                this.redirectUri = document.getElementById('redirectUri').value;
            }

            async getAuthUrl(userId) {
                this.updateConfig();
                
                if (!this.clientId || !this.clientSecret) {
                    throw new Error('è¯·å…ˆè®¾ç½® OAuth å®¢æˆ·ç«¯ ID å’Œå¯†é’¥');
                }

                const url = `${this.baseUrl}/api/v1/multi-user/auth?` +
                    `client_id=${encodeURIComponent(this.clientId)}&` +
                    `client_secret=${encodeURIComponent(this.clientSecret)}&` +
                    `redirect_uri=${encodeURIComponent(this.redirectUri)}`;

                const response = await safeFetch(url);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'è·å–æˆæƒ URL å¤±è´¥');
                }

                return data.data.auth_url;
            }

            async exchangeCodeForToken(code) {
                this.updateConfig();

                const formData = new FormData();
                formData.append('code', code);
                formData.append('client_id', this.clientId);
                formData.append('client_secret', this.clientSecret);
                formData.append('redirect_uri', this.redirectUri);

                const response = await safeFetch(`${this.baseUrl}/api/v1/multi-user/auth/callback`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'æ¢å–ä»¤ç‰Œå¤±è´¥');
                }

                return data.data.token;
            }

            async uploadFile(file, userToken, parentFolderId = null) {
                const formData = new FormData();
                formData.append('file', file);
                if (parentFolderId) {
                    formData.append('parent_folder_id', parentFolderId);
                }

                // éªŒè¯å’Œæ¸…ç†ç”¨æˆ·ä»¤ç‰Œ
                const cleanToken = validateAndCleanUserToken(userToken);

                const response = await safeFetch(`${this.baseUrl}/api/v1/multi-user/upload`, {
                    method: 'POST',
                    headers: {
                        'X-User-Token': cleanToken
                    },
                    body: formData
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'ä¸Šä¼ å¤±è´¥');
                }

                return data.data;
            }

            async listFiles(userToken, query = null, pageSize = 20) {
                // éªŒè¯å’Œæ¸…ç†ç”¨æˆ·ä»¤ç‰Œ
                const cleanToken = validateAndCleanUserToken(userToken);

                let url = `${this.baseUrl}/api/v1/multi-user/list?page_size=${pageSize}`;
                if (query) {
                    url += `&query=${encodeURIComponent(query)}`;
                }

                const response = await safeFetch(url, {
                    headers: {
                        'X-User-Token': cleanToken
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥');
                }

                return data.data;
            }

            async downloadFile(fileId, userToken) {
                // éªŒè¯å‚æ•°
                if (!fileId || typeof fileId !== 'string') {
                    throw new Error('æ— æ•ˆçš„æ–‡ä»¶ID');
                }
                
                // éªŒè¯å’Œæ¸…ç†ç”¨æˆ·ä»¤ç‰Œ
                const cleanToken = validateAndCleanUserToken(userToken);

                const response = await safeFetch(`${this.baseUrl}/api/v1/multi-user/download/${fileId}`, {
                    headers: {
                        'X-User-Token': cleanToken
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'ä¸‹è½½å¤±è´¥');
                }

                return response;
            }

            async getUserInfo(userToken) {
                // éªŒè¯å’Œæ¸…ç†ç”¨æˆ·ä»¤ç‰Œ
                const cleanToken = validateAndCleanUserToken(userToken);

                const response = await safeFetch(`${this.baseUrl}/api/v1/multi-user/user-info`, {
                    headers: {
                        'X-User-Token': cleanToken
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥');
                }

                return data.data;
            }
        }

        // å…¨å±€å®¢æˆ·ç«¯å®ä¾‹
        const client = new MultiUserGoogleDriveClient();

        // è¾…åŠ©å‡½æ•°
        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${content}</div>`;
        }

        function showError(elementId, error) {
            console.error('API Error:', error);
            showResult(elementId, `âŒ ${error.message}`, 'error');
        }

        function showSuccess(elementId, message) {
            showResult(elementId, `âœ… ${message}`, 'success');
        }

        // éªŒè¯å’Œæ¸…ç†ç”¨æˆ·ä»¤ç‰Œ
        function validateAndCleanUserToken(tokenStr) {
            if (!tokenStr || typeof tokenStr !== 'string') {
                throw new Error('ä»¤ç‰Œä¸èƒ½ä¸ºç©º');
            }

            // å»é™¤å‰åç©ºç™½å­—ç¬¦
            tokenStr = tokenStr.trim();
            
            if (!tokenStr) {
                throw new Error('ä»¤ç‰Œä¸èƒ½ä¸ºç©º');
            }

            // å°è¯•è§£æ JSON
            try {
                const token = JSON.parse(tokenStr);
                
                // éªŒè¯å¿…è¦å­—æ®µ
                if (!token.access_token) {
                    throw new Error('ä»¤ç‰Œç¼ºå°‘ access_token å­—æ®µ');
                }
                
                // è¿”å›æ¸…ç†åçš„ JSON å­—ç¬¦ä¸²
                return JSON.stringify(token);
            } catch (e) {
                if (e.message.includes('access_token')) {
                    throw e;
                }
                throw new Error('ä»¤ç‰Œæ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥ JSON æ ¼å¼');
            }
        }

        // å®‰å…¨çš„ fetch åŒ…è£…å™¨
        async function safeFetch(url, options = {}) {
            try {
                console.log('Fetching:', url, options);
                const response = await fetch(url, options);
                console.log('Response status:', response.status);
                return response;
            } catch (error) {
                console.error('Fetch error:', error);
                if (error.message.includes('Invalid value')) {
                    throw new Error('è¯·æ±‚å‚æ•°æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥å†…å®¹');
                }
                throw error;
            }
        }

        // API è°ƒç”¨å‡½æ•°
        async function getAuthUrl() {
            const userId = document.getElementById('userId').value;
            if (!userId) {
                showError('authResult', new Error('è¯·è¾“å…¥ç”¨æˆ· ID'));
                return;
            }

            try {
                const authUrl = await client.getAuthUrl(userId);
                showResult('authResult', 
                    `<strong>ç”¨æˆ· ${userId} çš„æˆæƒ URLï¼š</strong><br>` +
                    `<a href="${authUrl}" target="_blank" style="word-break: break-all;">${authUrl}</a><br><br>` +
                    `<div class="info">è¯·è®©ç”¨æˆ·ç‚¹å‡»ä¸Šæ–¹é“¾æ¥å®Œæˆ Google è´¦æˆ·æˆæƒ</div>`, 
                    'success'
                );
            } catch (error) {
                showError('authResult', error);
            }
        }

        async function exchangeCodeForToken() {
            const authCode = document.getElementById('authCode').value;
            if (!authCode) {
                showError('tokenResult', new Error('è¯·è¾“å…¥æˆæƒç '));
                return;
            }

            try {
                const token = await client.exchangeCodeForToken(authCode);
                document.getElementById('userToken').value = JSON.stringify(token, null, 2);
                showSuccess('tokenResult', 'ä»¤ç‰Œè·å–æˆåŠŸï¼å·²è‡ªåŠ¨å¡«å…¥ä¸‹æ–¹çš„ä»¤ç‰Œæ¡†');
            } catch (error) {
                showError('tokenResult', error);
            }
        }

        async function validateToken() {
            const userToken = document.getElementById('userToken').value;
            if (!userToken) {
                showError('userInfoResult', new Error('è¯·è¾“å…¥ç”¨æˆ·ä»¤ç‰Œ'));
                return;
            }

            try {
                validateAndCleanUserToken(userToken);
                showSuccess('userInfoResult', 'ä»¤ç‰Œæ ¼å¼æ­£ç¡®');
            } catch (error) {
                showError('userInfoResult', error);
            }
        }

        async function getUserInfo() {
            const userToken = document.getElementById('userToken').value;
            if (!userToken) {
                showError('userInfoResult', new Error('è¯·è¾“å…¥ç”¨æˆ·ä»¤ç‰Œ'));
                return;
            }

            try {
                const userInfo = await client.getUserInfo(userToken);
                const user = userInfo.user || {};
                const quota = userInfo.storage_quota || {};
                
                let quotaInfo = '';
                if (quota.limit) {
                    const usedGB = (parseInt(quota.usage || 0) / 1024 / 1024 / 1024).toFixed(2);
                    const totalGB = (parseInt(quota.limit) / 1024 / 1024 / 1024).toFixed(2);
                    const usagePercent = ((parseInt(quota.usage || 0) / parseInt(quota.limit)) * 100).toFixed(1);
                    quotaInfo = `<br><strong>å­˜å‚¨ä½¿ç”¨:</strong> ${usedGB} GB / ${totalGB} GB (${usagePercent}%)`;
                }

                showResult('userInfoResult', 
                    `<div class="user-info">` +
                    `<strong>ç”¨æˆ·ä¿¡æ¯ï¼š</strong><br>` +
                    `<strong>å§“å:</strong> ${user.displayName || 'æœªçŸ¥'}<br>` +
                    `<strong>é‚®ç®±:</strong> ${user.emailAddress || 'æœªçŸ¥'}` +
                    quotaInfo +
                    `</div>`, 
                    'success'
                );
            } catch (error) {
                showError('userInfoResult', error);
            }
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileUpload');
            const userToken = document.getElementById('userToken').value;
            const parentFolderId = document.getElementById('parentFolderId').value || null;

            if (!fileInput.files[0]) {
                showError('uploadResult', new Error('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶'));
                return;
            }

            if (!userToken) {
                showError('uploadResult', new Error('è¯·è¾“å…¥ç”¨æˆ·ä»¤ç‰Œ'));
                return;
            }

            try {
                const result = await client.uploadFile(fileInput.files[0], userToken, parentFolderId);
                showResult('uploadResult', 
                    `<strong>æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼š</strong><br>` +
                    `<strong>æ–‡ä»¶ ID:</strong> ${result.file_id}<br>` +
                    `<strong>æ–‡ä»¶å:</strong> ${result.name}<br>` +
                    `<strong>å¤§å°:</strong> ${result.size} bytes<br>` +
                    `<strong>ç±»å‹:</strong> ${result.mime_type}`, 
                    'success'
                );
                
                // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                fileInput.value = '';
                
                // è‡ªåŠ¨åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                setTimeout(() => listFiles(), 1000);
            } catch (error) {
                showError('uploadResult', error);
            }
        }

        async function listFiles(mimeTypeFilter = null) {
            const userToken = document.getElementById('userToken').value;
            const searchQuery = document.getElementById('searchQuery').value;

            if (!userToken) {
                showError('fileListResult', new Error('è¯·è¾“å…¥ç”¨æˆ·ä»¤ç‰Œ'));
                return;
            }

            try {
                let query = searchQuery;
                if (mimeTypeFilter) {
                    query = query ? `${query} and mimeType contains '${mimeTypeFilter}'` : `mimeType contains '${mimeTypeFilter}'`;
                }

                const result = await client.listFiles(userToken, query, 50);
                const files = result.files || [];

                if (files.length === 0) {
                    showResult('fileListResult', 'æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æ–‡ä»¶', 'info');
                    return;
                }

                let fileListHtml = `<strong>æ‰¾åˆ° ${files.length} ä¸ªæ–‡ä»¶ï¼š</strong><div class="file-list">`;
                files.forEach(file => {
                    const fileSize = file.size ? `${(file.size / 1024).toFixed(1)} KB` : 'æœªçŸ¥';
                    const createdTime = file.createdTime ? new Date(file.createdTime).toLocaleString('zh-CN') : 'æœªçŸ¥';
                    
                    fileListHtml += `
                        <div class="file-item">
                            <div>
                                <strong>${file.name}</strong><br>
                                <small>ID: ${file.id} | å¤§å°: ${fileSize} | åˆ›å»ºæ—¶é—´: ${createdTime}</small>
                            </div>
                            <div>
                                <button onclick="document.getElementById('downloadFileId').value='${file.id}'" style="font-size: 12px; padding: 5px 10px;">é€‰æ‹©ä¸‹è½½</button>
                            </div>
                        </div>
                    `;
                });
                fileListHtml += '</div>';

                showResult('fileListResult', fileListHtml, 'success');
            } catch (error) {
                showError('fileListResult', error);
            }
        }

        async function downloadFile() {
            const fileId = document.getElementById('downloadFileId').value;
            const userToken = document.getElementById('userToken').value;

            if (!fileId) {
                showError('downloadResult', new Error('è¯·è¾“å…¥æ–‡ä»¶ ID'));
                return;
            }

            if (!userToken) {
                showError('downloadResult', new Error('è¯·è¾“å…¥ç”¨æˆ·ä»¤ç‰Œ'));
                return;
            }

            try {
                const response = await client.downloadFile(fileId, userToken);
                
                // è·å–æ–‡ä»¶å
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `downloaded_${fileId}`;
                if (contentDisposition) {
                    const match = contentDisposition.match(/filename="?([^"]+)"?/);
                    if (match) {
                        filename = match[1];
                    }
                }

                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showSuccess('downloadResult', `æ–‡ä»¶ "${filename}" ä¸‹è½½æˆåŠŸ`);
            } catch (error) {
                showError('downloadResult', error);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ URL å‚æ•°ä¸­æ˜¯å¦åŒ…å«æˆæƒç 
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code) {
                document.getElementById('authCode').value = code;
                showResult('tokenResult', 'æ£€æµ‹åˆ°æˆæƒç ï¼Œè¯·ç‚¹å‡»"æ¢å–è®¿é—®ä»¤ç‰Œ"æŒ‰é’®', 'info');
            }

            // è®¾ç½®ç¤ºä¾‹ä»¤ç‰Œæ ¼å¼
            const exampleToken = {
                "access_token": "ya29.a0AfH6SMC_example_token",
                "refresh_token": "1//04_example_refresh_token", 
                "client_id": "your-client-id.apps.googleusercontent.com",
                "client_secret": "GOCSPX-your-client-secret",
                "token_uri": "https://oauth2.googleapis.com/token",
                "scopes": ["https://www.googleapis.com/auth/drive"]
            };

            // å¦‚æœä»¤ç‰Œæ¡†ä¸ºç©ºï¼Œæ˜¾ç¤ºç¤ºä¾‹æ ¼å¼
            const tokenTextarea = document.getElementById('userToken');
            if (!tokenTextarea.value.trim()) {
                tokenTextarea.placeholder = JSON.stringify(exampleToken, null, 2);
            }

            console.log('å¤šç”¨æˆ· Google Drive ç¤ºä¾‹é¡µé¢å·²åŠ è½½');
            console.log('å¦‚æœé‡åˆ° fetch é”™è¯¯ï¼Œè¯·æ£€æŸ¥ï¼š');
            console.log('1. æœåŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œ (http://localhost:8080)');
            console.log('2. ç”¨æˆ·ä»¤ç‰Œæ ¼å¼æ˜¯å¦æ­£ç¡®');
            console.log('3. æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„ç½‘ç»œé€‰é¡¹å¡');
        });
    </script>
</body>
</html>
